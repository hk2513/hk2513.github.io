<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>テスト対策クイズ（3モード対応版＋All/RetryボタンUI改善）</title>
  <style>
    body { font-family: sans-serif; padding: 2em; max-width: 700px; margin: auto; background:#f6f7fb}
    .quiz-container { border: 1px solid #ccc; padding: 1.5em; border-radius: 12px; margin-top: 1em; background:#fff}
    .choice-btn { display: block; margin: 0.5em 0; padding: 1em; font-size: 1em; width: 100%; border-radius: 6px; border: 1px solid #ccc; background: #f9f9f9; cursor: pointer; text-align: center; }
    .choice-btn:hover { background: #cce; }
    .choice-check { display: none; }
    .choice-label { display: block; margin: 0.5em 0; padding: 1em; font-size: 1em; border-radius: 6px; border: 1px solid #ccc; cursor: pointer; text-align: center; background: #f9f9f9; }
    .choice-check:checked + .choice-label { background: #cce; border-color: #88f; }
    .result { font-weight: bold; margin-top: 1em; }
    .explanation { margin-top: 1em; background: #f8f8ff; padding: 0.8em; border-radius: 8px; }
    /* ---- Nextボタン ---- */
    #nextBtn {
      display: block; width: 100%; padding: 1em; font-size: 1.1em; border: none; border-radius: 10px;
      color: #fff; background: #3498db; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      cursor: pointer; transition: transform 0.05s ease, opacity 0.2s ease;
      margin-top: 1.5em;
    }
    #nextBtn:hover { opacity: 0.92; transform: translateY(-1px); }
    #nextBtn:active { transform: translateY(0); }
    /* ---- 3モードのボタン ---- */
    #restartBtnAll, #retryWrongBtn, #retryLastBtn {
      display: block; width: 100%; padding: 1em; margin-top: 0.5em;
      font-size: 1.1em; border: none; border-radius: 10px; color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15); cursor: pointer;
      transition: transform 0.05s ease, opacity 0.2s ease;
    }
    #restartBtnAll { background: #e67e22; }
    #retryWrongBtn { background: #e74c3c; }
    #retryLastBtn { background: #9b59b6; }
    #restartBtnAll:hover, #retryWrongBtn:hover, #retryLastBtn:hover { opacity: 0.92; transform: translateY(-1px); }
    #restartBtnAll:active, #retryWrongBtn:active, #retryLastBtn:active { transform: translateY(0); }
  
    input[type="text"] {
      font-size: 16px;
      padding: 0.5em;
      width: 100%;
      box-sizing: border-box;
    }

    /* 問題文を大きくする */
    .question-text {
      font-size: 20px;
      line-height: 1.6;
    }

    /* 選択肢ボタン（Single/マルチ共通） */
    .choice-btn, .choice-label {
      font-size: 20px;
      padding: 1.2em;
    }

    /* ナビゲーションボタン（次の問題へ、やり直しモードなど） */
    .nav-btn {
      font-size: 18px;
      padding: 1em 2em;
    }

    /*回答するボタン*/
    .answer-btn {
        display: block;
        width: 100%;
        margin-top: 1em;
        padding: 1.2em;
        font-size: 1.1em;
        font-weight: bold;
        border: none;
        border-radius: 10px;
        color: #fff;
        background: #28a745; /* 緑とか、選択肢と違う色 */
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        cursor: pointer;
        transition: background 0.2s, transform 0.1s;
    }
    .answer-btn:hover {
        background: #218838;
        transform: translateY(-1px);
    }

    /* 無効化しても色が薄くなりすぎないように */
    .choice-btn:disabled { opacity: 1; cursor: default; }

    /* 選択・正解・不正解の視覚化 */
    .choice-btn.selected   { background: #cce; }
    .choice-btn.correct    { background: #d1fae5; border: 1px solid #10b981; }
    .choice-label.correct  { background: #d1fae5 !important; border: 1px solid #10b981 !important; }

    /*回答するボタンの無効化*/
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .quiz-container img {
      max-width: 30%;   /* 親要素の9割までに制限 */
      height: auto;
      display: block;
      margin: 0.5em auto;
    }


</style>
</head>
<body>
  <h1>テスト対策クイズ</h1>
  <p>CSVファイルを読み込んでクイズを開始します。</p>
  <input type="file" id="csvInput">
  <div id="quiz" class="quiz-container" style="display:none;"></div>
  <button id="nextBtn" style="display:none;">次の問題へ</button>
  <button id="restartBtnAll" style="display:none;">全問題をやり直す</button>
  <button id="retryWrongBtn" style="display:none;">間違えた問題だけやり直す</button>
  <button id="retryLastBtn" style="display:none;">今やった問題だけやり直す</button>
  <div id="score"></div>

  <script>
    let allQuestions = [];
    let quizData = [];
    let current = 0;
    let correct = 0;
    let wrongQuestions = [];
    let lastPlayedQuestions = [];

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    document.getElementById('csvInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        parseCSV(ev.target.result);
        startQuiz(allQuestions);
      };
      reader.readAsText(file, 'utf-8');
    });

    function splitCSVLine(line) {
      const result = [];
      let current = '';
      let insideQuote = false;
      for (let i=0; i<line.length; i++) {
        const char = line[i];
        if (char === '"') {
          insideQuote = !insideQuote;
        } else if (char === ',' && !insideQuote) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current);
      return result;
    }

    function parseCSV(data) {
      allQuestions = [];
      const lines = data.trim().split(/\r?\n/);
      for (let i = 1; i < lines.length; i++) {
        let items = splitCSVLine(lines[i]);
        if (items.length < 5) continue;
        const type = items[0].trim();
        const question = items[1].trim();
        const choices = items.slice(2, 8).filter(c => c.trim() !== "");
        const answer = items[8].trim();
        const explanation = items.slice(9).join(",");
        allQuestions.push({ type, question, choices, answer, explanation });
      }
    }

    function startQuiz(questionSet) {
      quizData = [...questionSet];
      shuffleArray(quizData);
      current = 0;
      correct = 0;
      wrongQuestions = [];
      lastPlayedQuestions = quizData;
      document.getElementById('score').innerHTML = '';
      document.getElementById('restartBtnAll').style.display = 'none';
      document.getElementById('retryWrongBtn').style.display = 'none';
      document.getElementById('retryLastBtn').style.display = 'none';
      showQuiz();
    }

    function showQuiz() {
      if (current >= quizData.length) {
        document.getElementById('quiz').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('restartBtnAll').style.display = '';
        if (wrongQuestions.length > 0) {
          document.getElementById('retryWrongBtn').style.display = '';
        }
        document.getElementById('retryLastBtn').style.display = '';
        document.getElementById('score').innerHTML = `<b>終了！</b><br>正答数: ${correct} / ${quizData.length} (${Math.round(correct/quizData.length*100)}%)`;
        return;
      }
      const q = quizData[current];
      let html = `<div class="question-text"><b>Q${current+1}.</b> ${q.question}</div>`;

      if (q.type === "single") {
        const pairs = q.choices.map((c, idx) => ({ text: c, idx: idx+1 }));
        shuffleArray(pairs);
        q.shuffled = pairs;
        html += pairs.map((c, idx) =>
          `<button class="choice-btn" onclick="checkAnswerSingle(${idx+1})">${c.text}</button>`
        ).join("");
      } else if (q.type === "multi") {
        const pairs = q.choices.map((c, idx) => ({ text: c, idx: idx+1 }));
        shuffleArray(pairs);
        q.shuffled = pairs;
        html += pairs.map((c, idx) =>
          `<label><input type="checkbox" class="choice-check" value="${c.idx}"><span class="choice-label">${c.text}</span></label>`
        ).join("");
        html += `<button id="answerBtn" class="answer-btn" onclick="checkAnswerMulti()">回答する</button>`;
      } else if (q.type === "text") {
        html += `<input type="text" id="textAnswer" placeholder="ここに入力" style="width:100%; padding:0.5em;">`;
        html += `<button id="answerBtn" class="answer-btn" onclick="checkAnswerText()">回答する</button>`;
      }

      html += `<div id="result" class="result"></div>`;
      html += `<div id="explanation" class="explanation" style="display:none;"></div>`;
      document.getElementById('quiz').innerHTML = html;
      document.getElementById('quiz').style.display = '';
      document.getElementById('nextBtn').style.display = 'none';
    }

    window.checkAnswerSingle = function(choice) {
      const q = quizData[current];
      const correctIdx = q.shuffled.findIndex(p => p.idx === parseInt(q.answer, 10)) + 1;
      const res = document.getElementById('result');
      const exp = document.getElementById('explanation');
      if (choice === correctIdx) {
        res.innerHTML = "正解！";
        res.style.color = "green";
        correct++;
      } else {
        res.innerHTML = `不正解… 正解: ${q.shuffled[correctIdx-1].text}`;
        res.style.color = "red";
        wrongQuestions.push(q);
      }
      exp.innerHTML = q.explanation;
      exp.style.display = "";

      document.getElementById('nextBtn').style.display = '';
      //ボタンの無効化
      const buttons = Array.from(document.querySelectorAll('.choice-btn'));

      // まず選んだボタンにマーク
      buttons[choice - 1]?.classList.add('selected');

      if (choice === correctIdx) {
        buttons[choice - 1]?.classList.add('correct');
      } else {
        buttons[correctIdx - 1]?.classList.add('correct');
      }

      // その後で無効化（操作はできないけど見た目は保つ）
      buttons.forEach(btn => btn.disabled = true);
      
    };

    window.checkAnswerMulti = function() {
      const q = quizData[current];
      const correctAnswers = q.answer.split("|").map(x => parseInt(x.trim(), 10));
      const checked = Array.from(document.querySelectorAll(".choice-check:checked")).map(c => parseInt(c.value, 10));
      const res = document.getElementById('result');
      const exp = document.getElementById('explanation');
      if (JSON.stringify(checked.sort()) === JSON.stringify(correctAnswers.sort())) {
        res.innerHTML = "正解！";
        res.style.color = "green";
        correct++;
      } else {
        const correctTexts = q.shuffled.filter(p => correctAnswers.includes(p.idx)).map(p => p.text);
        res.innerHTML = `不正解… 正解: ${correctTexts.join(",")}`;
        res.style.color = "red";
        wrongQuestions.push(q);
      }
      exp.innerHTML = q.explanation;
      exp.style.display = "";

      document.getElementById('nextBtn').style.display = '';

      const labels = document.querySelectorAll('.choice-label');
      const checks = document.querySelectorAll('.choice-check');

      labels.forEach((label, i) => {
        const originalIdx = q.shuffled[i].idx;   // シャッフル前の番号
        const isCorrect = correctAnswers.includes(originalIdx);
        const isSelected = checks[i].checked;

        if (isCorrect) {
          // 正解は必ず緑
          label.classList.add('correct');
        }
      })

      document.querySelectorAll('.choice-check').forEach(c => c.disabled = true);
      document.getElementById("answerBtn").disabled = true;

    };

    window.checkAnswerText = function() {
      const q = quizData[current];
      const userAns = document.getElementById("textAnswer").value.trim();
      const res = document.getElementById('result');
      const exp = document.getElementById('explanation');
      if (userAns === q.answer) {
        res.innerHTML = `正解！`;
        res.style.color = "green";
        correct++;
      } else {
        res.innerHTML = `不正解… 正解: ${q.answer}`;
        res.style.color = "red";
        wrongQuestions.push(q);
      }
      exp.innerHTML = q.explanation;
      exp.style.display = "";

      document.getElementById('nextBtn').style.display = '';

      //入力欄の無効化
      document.getElementById('textAnswer').readOnly = true;
      document.getElementById("answerBtn").disabled = true;
    };

    document.getElementById('nextBtn').addEventListener('click', function() {
      current++;
      showQuiz();
    });

    document.getElementById('restartBtnAll').addEventListener('click', function() {
      startQuiz(allQuestions);
    });

    document.getElementById('retryWrongBtn').addEventListener('click', function() {
      if (wrongQuestions.length === 0) return;
      startQuiz(wrongQuestions);
    });

    document.getElementById('retryLastBtn').addEventListener('click', function() {
      if (lastPlayedQuestions.length === 0) return;
      startQuiz(lastPlayedQuestions);
    });
  </script>
</body>
</html>
