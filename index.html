<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>テスト対策クイズ</title>
  <style>
    body { font-family: sans-serif; padding: 1em; max-width: 700px; margin: auto; background:#f6f7fb; }
    .card { background:#fff; border-radius: 12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); padding:2em; margin-top:1em; }
    .choice-btn { display:block; margin:1.2em 0; padding:1.6em; border-radius:12px; border:2px solid #ddd; background:#f9f9f9; cursor:pointer; width:100%; font-size:1.4em; line-height:1.5; }
    .choice-btn:hover { background:#eef; }
    .result { font-weight:bold; margin:1.2em 0; font-size:1.3em; }
    .explanation { margin:1.2em 0; background:#f8f8ff; padding:1.4em; border-radius:10px; border:1px dashed #ccc; line-height:1.7; font-size:1.2em; }
    #nextBtn { display:block; margin:1.8em auto; background:#4b6ef5; color:#fff; border:none; padding:1.2em 1.8em; border-radius:10px; cursor:pointer; font-size:1.4em; width:100%; }
    #nextBtn:disabled { background:#aaa; cursor:not-allowed; }
    #score { text-align:center; margin-top:1.2em; font-weight:bold; font-size:1.3em; }
    h1 { margin-bottom:0.6em; text-align:center; }
    .question-text { font-size:1.5em; line-height:1.7; margin-bottom:1.2em; }

    /* スマホ向け調整 */
    @media (max-width: 600px) {
      body { padding: 0.6em; }
      .card { padding: 1.5em; }
      .choice-btn { font-size: 1.5em; padding: 1.6em; margin:1.4em 0; }
      #nextBtn { width: 100%; font-size: 1.5em; padding: 1.4em; }
      h1 { font-size: 1.8em; text-align:center; }
      .question-text { font-size:1.6em; }
    }
  </style>
</head>
<body>
  <h1>テスト対策クイズ</h1>
  <p style="text-align:center;">CSVファイルを選んで読み込むとクイズが始まります。</p>
  <div style="text-align:center; margin:1em 0;">
    <input type="file" id="csvInput">
  </div>
  <div id="quiz" class="card" style="display:none;"></div>
  <button id="nextBtn" style="display:none;">次の問題へ</button>
  <div id="score"></div>

<script>
let quizData = [];
let current = 0;
let correct = 0;

function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function splitCSVLine(line) {
  const result = [];
  let current = '';
  let insideQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"') {
      if (insideQuotes && line[i+1] === '"') {
        current += '"';
        i++;
      } else {
        insideQuotes = !insideQuotes;
      }
    } else if (char === ',' && !insideQuotes) {
      result.push(current);
      current = '';
    } else {
      current += char;
    }
  }
  result.push(current);
  return result;
}

document.getElementById('csvInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    parseCSV(ev.target.result);
    current = 0;
    correct = 0;
    document.getElementById('score').innerText = '';
    showQuiz();
  };
  reader.readAsText(file, 'utf-8');
});

function parseCSV(data) {
  quizData = [];
  const lines = data.trim().split(/\r?\n/);
  for (let i = 1; i < lines.length; i++) {
    let items = lines[i].split(',');
    if (items.length < 7) {
      items = splitCSVLine(lines[i]);
    }
    if (items.length < 7) continue;
    const explanation = items.slice(6).join(',');
    quizData.push({
      question: items[0],
      choices: items.slice(1, 5),
      answer: parseInt(items[5], 10),
      explanation: explanation
    });
  }
  shuffleArray(quizData);
}

function showQuiz() {
  if (current >= quizData.length) {
    document.getElementById('quiz').style.display = 'none';
    document.getElementById('nextBtn').style.display = 'none';
    document.getElementById('score').innerHTML = `<b>終了！</b><br>正答数: ${correct} / ${quizData.length} (${quizData.length > 0 ? (correct/quizData.length*100).toFixed(1) : 0}%)`;
    return;
  }
  const q = quizData[current];
  const pairs = q.choices.map((c, idx) => ({ text: c, idx: idx+1 }));
  shuffleArray(pairs);
  q.shuffled = pairs;
  q.correctIndex = pairs.findIndex(p => p.idx === q.answer) + 1;

  let html = `<div class="question-text"><b>Q${current+1}. </b>${q.question}</div>`;
  pairs.forEach((c, idx) => {
    html += `<button class="choice-btn" onclick="checkAnswer(${idx+1})">${c.text}</button>`;
  });
  html += `<div id="result" class="result"></div>`;
  html += `<div id="explanation" class="explanation" style="display:none;"></div>`;
  document.getElementById('quiz').innerHTML = html;
  document.getElementById('quiz').style.display = '';
  document.getElementById('nextBtn').style.display = 'none';
}

window.checkAnswer = function(choice) {
  const q = quizData[current];
  const res = document.getElementById('result');
  const exp = document.getElementById('explanation');
  if (choice === q.correctIndex) {
    res.innerHTML = '正解！';
    res.style.color = 'green';
    correct++;
  } else {
    res.innerHTML = `不正解…<br>正解: ${q.shuffled[q.correctIndex-1].text}`;
    res.style.color = 'red';
  }
  exp.innerHTML = q.explanation.replace(/\n/g, '<br>');
  exp.style.display = '';
  Array.from(document.getElementsByClassName('choice-btn')).forEach(btn => btn.disabled = true);
  document.getElementById('nextBtn').style.display = '';
};

document.getElementById('nextBtn').addEventListener('click', function() {
  current++;
  showQuiz();
});
</script>
</body>
</html>
